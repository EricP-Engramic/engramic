# Copyright (c) 2025 Preisz Consulting, LLC.
# This file is part of Engramic, licensed under the Engramic Community License.
# See the LICENSE file in the project root for more details.

import logging
from typing import Any

import pluggy

from engramic.core.interface.llm import LLM
from engramic.core.prompt import Prompt
from engramic.infrastructure.system.plugin_specifications import llm_impl
from engramic.infrastructure.system.websocket_manager import WebsocketManager


class Mock(LLM):
    @llm_impl
    def submit(self, prompt: Prompt, structured_schema: dict[str, Any], args: dict[str, str]) -> dict[str, Any]:
        del structured_schema
        hint = args.get('hint')
        logging.info('user prompt: %.25s...', prompt.prompt_str)

        if hint == 'retrieve_gen_conversation_direction':
            return {'llm_response': 'Asking about a podcast.'}

        if hint == 'retrieve_prompt_analysis':
            return {'llm_response': '{"type": "engram", "complexity": "simple"}'}

        if hint == 'retrieve_gen_index':
            return {'llm_response': '{"indices": ["Who is in the podcast?", "What is the podcast about?"]}'}

        if hint == 'response_main':
            response_str = {
                'llm_response': [
                    'The',
                    ' All-In',
                    ' Podcast',
                    ' is',
                    ' a',
                    ' popular',
                    ' weekly',
                    ' podcast',
                    ' hosted',
                    ' by',
                    ' four',
                    ' prominent',
                    ' figures',
                    ' in',
                    ' the',
                    ' tech',
                    ' and',
                    ' venture',
                    ' capital',
                    ' world',
                    ':\n\n',
                    '*',
                    ' ',
                    '**Chamath',
                    ' Palihapitiya:**',
                    ' A',
                    ' venture',
                    ' capitalist',
                    ' and',
                    ' former',
                    ' Facebook',
                    ' executive',
                    ' known',
                    ' for',
                    ' his',
                    ' bold',
                    ' opinions',
                    ' and',
                    ' investment',
                    ' strategies.\n',
                    '*',
                    ' ',
                    '**Jason',
                    ' Calacanis:**',
                    ' An',
                    ' angel',
                    ' investor,',
                    ' entrepreneur,',
                    ' and',
                    ' blogger',
                    ' who',
                    ' founded',
                    ' Launch',
                    ' Festival',
                    ' and',
                    ' the',
                    ' This',
                    ' Week',
                    ' in',
                    ' Startups',
                    ' podcast.\n',
                    '*',
                    ' ',
                    '**David',
                    ' Sacks:**',
                    ' An',
                    ' entrepreneur,',
                    ' investor,',
                    ' and',
                    ' author.',
                    ' He',
                    ' co-founded',
                    ' PayPal',
                    ' and',
                    ' Yammer.\n',
                    '*',
                    ' ',
                    '**David',
                    ' Friedberg:**',
                    ' An',
                    ' entrepreneur',
                    ' and',
                    ' investor',
                    ' focused',
                    ' on',
                    ' science',
                    ' and',
                    ' technology,',
                    ' especially',
                    ' in',
                    ' the',
                    ' fields',
                    ' of',
                    ' agriculture',
                    ' and',
                    ' healthcare.\n\n',
                    "**Here's",
                    ' a',
                    ' breakdown',
                    ' of',
                    ' what',
                    ' the',
                    ' podcast',
                    ' is',
                    ' known',
                    ' for:**\n\n',
                    '*',
                    ' ',
                    '**Topics:**',
                    ' The',
                    ' podcast',
                    ' covers',
                    ' a',
                    ' wide',
                    ' range',
                    ' of',
                    ' topics,',
                    ' including:\n',
                    '    *',
                    ' ',
                    'Technology',
                    ' and',
                    ' startups\n',
                    '    *',
                    ' ',
                    'Business',
                    ' and',
                    ' finance\n',
                    '    *',
                    ' ',
                    'Venture',
                    ' capital',
                    ' and',
                    ' investing\n',
                    '    *',
                    ' ',
                    'Politics',
                    ' and',
                    ' current',
                    ' events\n',
                    '    *',
                    ' ',
                    'Macroeconomics\n',
                    '*',
                    ' ',
                    '**Format:**',
                    ' The',
                    ' podcast',
                    ' typically',
                    ' features',
                    ' a',
                    ' roundtable',
                    ' discussion',
                    ' format,',
                    ' where',
                    ' the',
                    ' hosts',
                    ' share',
                    ' their',
                    ' perspectives',
                    ' and',
                    ' debate',
                    ' various',
                    ' topics.',
                    ' They',
                    ' often',
                    ' use',
                    ' data',
                    ' and',
                    ' statistics',
                    ' to',
                    ' support',
                    ' their',
                    ' arguments.\n',
                    '*',
                    ' ',
                    '**Style:**',
                    ' The',
                    ' podcast',
                    ' is',
                    ' known',
                    ' for',
                    ' its',
                    ' outspoken',
                    ' and',
                    ' often',
                    ' controversial',
                    ' opinions.',
                    ' The',
                    ' hosts',
                    " don't",
                    ' shy',
                    ' away',
                    ' from',
                    ' expressing',
                    ' their',
                    ' views',
                    ' on',
                    ' sensitive',
                    ' subjects,',
                    ' which',
                    ' has',
                    ' both',
                    ' attracted',
                    ' a',
                    ' large',
                    ' following',
                    ' and',
                    ' drawn',
                    ' criticism.',
                    ' Their',
                    ' discussions',
                    ' are',
                    ' often',
                    ' lively,',
                    ' engaging,',
                    ' and',
                    ' sometimes',
                    ' combative.\n',
                    '*',
                    ' ',
                    '**Audience:**',
                    ' The',
                    ' All-In',
                    ' Podcast',
                    ' has',
                    ' a',
                    ' large',
                    ' and',
                    ' dedicated',
                    ' following,',
                    ' particularly',
                    ' among',
                    ' entrepreneurs,',
                    ' investors,',
                    ' and',
                    ' those',
                    ' interested',
                    ' in',
                    ' technology,',
                    ' business,',
                    ' and',
                    ' finance.\n',
                    '*',
                    ' ',
                    '**Controversies:**',
                    ' The',
                    ' podcast',
                    ' has',
                    ' been',
                    ' the',
                    ' subject',
                    ' of',
                    ' controversy',
                    ' due',
                    ' to',
                    ' some',
                    ' of',
                    ' the',
                    " hosts'",
                    ' views',
                    ' on',
                    ' political',
                    ' and',
                    ' social',
                    ' issues.',
                    ' Chamath',
                    ' Palihapitiya,',
                    ' in',
                    ' particular,',
                    ' has',
                    ' faced',
                    ' criticism',
                    ' for',
                    ' some',
                    ' of',
                    ' his',
                    ' comments.\n\n',
                    '**In',
                    ' summary:**',
                    ' The',
                    ' All-In',
                    ' Podcast',
                    ' is',
                    ' a',
                    ' high-profile,',
                    ' opinionated,',
                    ' and',
                    ' often',
                    ' controversial',
                    ' podcast',
                    ' featuring',
                    ' four',
                    ' well-known',
                    ' figures',
                    ' from',
                    ' the',
                    ' tech',
                    ' and',
                    ' venture',
                    ' capital',
                    ' world.',
                    ' It',
                    ' provides',
                    ' a',
                    ' platform',
                    ' for',
                    ' them',
                    ' to',
                    ' discuss',
                    ' and',
                    ' debate',
                    ' a',
                    ' wide',
                    ' range',
                    ' of',
                    ' topics,',
                    ' making',
                    ' it',
                    ' a',
                    ' popular',
                    ' listen',
                    ' for',
                    ' those',
                    ' interested',
                    ' in',
                    ' technology,',
                    ' business,',
                    ' finance,',
                    ' and',
                    ' current',
                    ' events.',
                    ' However,',
                    ' be',
                    ' prepared',
                    ' for',
                    ' strong',
                    ' opinions',
                    ' and',
                    ' potentially',
                    ' controversial',
                    ' viewpoints.',
                    '\n',
                ]
            }
            full_string = ''
            for token in response_str:
                full_string += token
            return {'llm_response': full_string}

        if hint == 'validate':
            full_string = """```toml\n[[engram]]\nlocations = ["LLM://Gemini2.0"]\ncontent = "The All-In Podcast is hosted by Chamath Palihapitiya, Jason Calacanis, David Sacks, and David Friedberg."\nis_native_source = true\n\n[[engram]]\nlocations = ["LLM://Gemini2.0"]\ncontent = "The podcast covers technology, startups, business, finance, venture capital, investing, politics, current events, and macroeconomics."\nis_native_source = true\n\n[[engram]]\nlocations = ["LLM://Gemini2.0"]\ncontent = "The All-In Podcast is known for its outspoken and often controversial opinions, sparking lively and sometimes combative discussions."\nis_native_source = true\n\n[meta]\nlocations = ["LLM://Gemini2.0"]\nkeywords = ["podcast", "venture capital", "technology", "finance", "controversial"]\nsummary_full = "The All-In Podcast features tech and venture capital figures discussing business, finance, and current events with outspoken opinions."\n```"""
            if full_string.startswith('```toml') and full_string.endswith('```'):
                full_string = full_string[7:-3]
            return {'llm_response': full_string}

        if hint == 'summary':
            return {'llm_response': 'The podcast is about politics.'}

        if hint == 'gen_indices':
            return {
                'llm_response': '{\n  "index_text_array": [\n    "All-In Podcast hosts: Chamath Palihapitiya, Jason Calacanis, David Sacks, David Friedberg"\n  ]\n}'
            }
        return {}

    @llm_impl
    def submit_streaming(
        self, prompt: Prompt, args: dict[str, str], websocket_manager: WebsocketManager
    ) -> dict[str, str]:
        hint = args.get('hint')

        if hint == 'response_main':
            del prompt
            response_str = [
                'The',
                ' All-In',
                ' Podcast',
                ' is',
                ' a',
                ' popular',
                ' weekly',
                ' podcast',
                ' hosted',
                ' by',
                ' four',
                ' prominent',
                ' figures',
                ' in',
                ' the',
                ' tech',
                ' and',
                ' venture',
                ' capital',
                ' world',
                ':\n\n',
                '*',
                ' ',
                '**Chamath',
                ' Palihapitiya:**',
                ' A',
                ' venture',
                ' capitalist',
                ' and',
                ' former',
                ' Facebook',
                ' executive',
                ' known',
                ' for',
                ' his',
                ' bold',
                ' opinions',
                ' and',
                ' investment',
                ' strategies.\n',
                '*',
                ' ',
                '**Jason',
                ' Calacanis:**',
                ' An',
                ' angel',
                ' investor,',
                ' entrepreneur,',
                ' and',
                ' blogger',
                ' who',
                ' founded',
                ' Launch',
                ' Festival',
                ' and',
                ' the',
                ' This',
                ' Week',
                ' in',
                ' Startups',
                ' podcast.\n',
                '*',
                ' ',
                '**David',
                ' Sacks:**',
                ' An',
                ' entrepreneur,',
                ' investor,',
                ' and',
                ' author.',
                ' He',
                ' co-founded',
                ' PayPal',
                ' and',
                ' Yammer.\n',
                '*',
                ' ',
                '**David',
                ' Friedberg:**',
                ' An',
                ' entrepreneur',
                ' and',
                ' investor',
                ' focused',
                ' on',
                ' science',
                ' and',
                ' technology,',
                ' especially',
                ' in',
                ' the',
                ' fields',
                ' of',
                ' agriculture',
                ' and',
                ' healthcare.\n\n',
                "**Here's",
                ' a',
                ' breakdown',
                ' of',
                ' what',
                ' the',
                ' podcast',
                ' is',
                ' known',
                ' for:**\n\n',
                '*',
                ' ',
                '**Topics:**',
                ' The',
                ' podcast',
                ' covers',
                ' a',
                ' wide',
                ' range',
                ' of',
                ' topics,',
                ' including:\n',
                '    *',
                ' ',
                'Technology',
                ' and',
                ' startups\n',
                '    *',
                ' ',
                'Business',
                ' and',
                ' finance\n',
                '    *',
                ' ',
                'Venture',
                ' capital',
                ' and',
                ' investing\n',
                '    *',
                ' ',
                'Politics',
                ' and',
                ' current',
                ' events\n',
                '    *',
                ' ',
                'Macroeconomics\n',
                '*',
                ' ',
                '**Format:**',
                ' The',
                ' podcast',
                ' typically',
                ' features',
                ' a',
                ' roundtable',
                ' discussion',
                ' format,',
                ' where',
                ' the',
                ' hosts',
                ' share',
                ' their',
                ' perspectives',
                ' and',
                ' debate',
                ' various',
                ' topics.',
                ' They',
                ' often',
                ' use',
                ' data',
                ' and',
                ' statistics',
                ' to',
                ' support',
                ' their',
                ' arguments.\n',
                '*',
                ' ',
                '**Style:**',
                ' The',
                ' podcast',
                ' is',
                ' known',
                ' for',
                ' its',
                ' outspoken',
                ' and',
                ' often',
                ' controversial',
                ' opinions.',
                ' The',
                ' hosts',
                " don't",
                ' shy',
                ' away',
                ' from',
                ' expressing',
                ' their',
                ' views',
                ' on',
                ' sensitive',
                ' subjects,',
                ' which',
                ' has',
                ' both',
                ' attracted',
                ' a',
                ' large',
                ' following',
                ' and',
                ' drawn',
                ' criticism.',
                ' Their',
                ' discussions',
                ' are',
                ' often',
                ' lively,',
                ' engaging,',
                ' and',
                ' sometimes',
                ' combative.\n',
                '*',
                ' ',
                '**Audience:**',
                ' The',
                ' All-In',
                ' Podcast',
                ' has',
                ' a',
                ' large',
                ' and',
                ' dedicated',
                ' following,',
                ' particularly',
                ' among',
                ' entrepreneurs,',
                ' investors,',
                ' and',
                ' those',
                ' interested',
                ' in',
                ' technology,',
                ' business,',
                ' and',
                ' finance.\n',
                '*',
                ' ',
                '**Controversies:**',
                ' The',
                ' podcast',
                ' has',
                ' been',
                ' the',
                ' subject',
                ' of',
                ' controversy',
                ' due',
                ' to',
                ' some',
                ' of',
                ' the',
                " hosts'",
                ' views',
                ' on',
                ' political',
                ' and',
                ' social',
                ' issues.',
                ' Chamath',
                ' Palihapitiya,',
                ' in',
                ' particular,',
                ' has',
                ' faced',
                ' criticism',
                ' for',
                ' some',
                ' of',
                ' his',
                ' comments.\n\n',
                '**In',
                ' summary:**',
                ' The',
                ' All-In',
                ' Podcast',
                ' is',
                ' a',
                ' high-profile,',
                ' opinionated,',
                ' and',
                ' often',
                ' controversial',
                ' podcast',
                ' featuring',
                ' four',
                ' well-known',
                ' figures',
                ' from',
                ' the',
                ' tech',
                ' and',
                ' venture',
                ' capital',
                ' world.',
                ' It',
                ' provides',
                ' a',
                ' platform',
                ' for',
                ' them',
                ' to',
                ' discuss',
                ' and',
                ' debate',
                ' a',
                ' wide',
                ' range',
                ' of',
                ' topics,',
                ' making',
                ' it',
                ' a',
                ' popular',
                ' listen',
                ' for',
                ' those',
                ' interested',
                ' in',
                ' technology,',
                ' business,',
                ' finance,',
                ' and',
                ' current',
                ' events.',
                ' However,',
                ' be',
                ' prepared',
                ' for',
                ' strong',
                ' opinions',
                ' and',
                ' potentially',
                ' controversial',
                ' viewpoints.',
                '\n',
            ]

            full_string = ''
            for llm_token in response_str:
                full_string += llm_token
                if llm_token != '.':
                    websocket_manager.send_message(LLM.StreamPacket(llm_token, False, ''))
                else:
                    websocket_manager.send_message(LLM.StreamPacket(llm_token, True, 'End'))
            return {'llm_response': full_string}

        return {}


pm = pluggy.PluginManager('llm')
pm.register(Mock())
